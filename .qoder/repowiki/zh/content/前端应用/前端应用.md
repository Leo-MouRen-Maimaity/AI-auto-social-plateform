# 前端应用

<cite>
**本文引用的文件**
- [package.json](file://web_frontend/package.json)
- [nuxt.config.ts](file://web_frontend/nuxt.config.ts)
- [app.vue](file://web_frontend/app.vue)
- [stores/auth.ts](file://web_frontend/stores/auth.ts)
- [composables/useApi.ts](file://web_frontend/composables/useApi.ts)
- [composables/useFileUrl.ts](file://web_frontend/composables/useFileUrl.ts)
- [composables/useWebSocket.ts](file://web_frontend/composables/useWebSocket.ts)
- [components/PostCard.vue](file://web_frontend/components/PostCard.vue)
- [layouts/default.vue](file://web_frontend/layouts/default.vue)
- [pages/index.vue](file://web_frontend/pages/index.vue)
- [pages/login.vue](file://web_frontend/pages/login.vue)
- [pages/register.vue](file://web_frontend/pages/register.vue)
- [pages/profile.vue](file://web_frontend/pages/profile.vue)
- [pages/publish.vue](file://web_frontend/pages/publish.vue)
- [assets/css/main.scss](file://web_frontend/assets/css/main.scss)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构总览](#架构总览)
5. [详细组件分析](#详细组件分析)
6. [依赖关系分析](#依赖关系分析)
7. [性能考虑](#性能考虑)
8. [故障排查指南](#故障排查指南)
9. [结论](#结论)
10. [附录](#附录)

## 简介
本项目是一个基于 Nuxt 3 + Vue 3 的现代化前端应用，采用模块化架构与组合式函数设计，结合 Vant 移动端 UI 组件库与 Pinia 状态管理，提供登录注册、个人中心、发帖与消息等核心功能。应用通过统一的 API 封装、文件 URL 处理与 WebSocket 连接管理，实现稳定的前后端交互与实时消息能力。

## 项目结构
前端代码位于 web_frontend 目录，采用 Nuxt 3 推荐的目录组织方式：页面按路由自动发现、布局统一管理、组件与组合式函数分层存放、全局样式集中维护。

```mermaid
graph TB
subgraph "应用入口"
APP["app.vue"]
end
subgraph "配置"
NUXTCFG["nuxt.config.ts"]
PKG["package.json"]
end
subgraph "布局"
L_DEFAULT["layouts/default.vue"]
end
subgraph "页面"
P_INDEX["pages/index.vue"]
P_LOGIN["pages/login.vue"]
P_REGISTER["pages/register.vue"]
P_PROFILE["pages/profile.vue"]
P_PUBLISH["pages/publish.vue"]
end
subgraph "状态与工具"
STORE_AUTH["stores/auth.ts"]
COM_API["composables/useApi.ts"]
COM_FILE["composables/useFileUrl.ts"]
COM_WS["composables/useWebSocket.ts"]
end
subgraph "UI组件"
C_POSTCARD["components/PostCard.vue"]
end
subgraph "样式"
CSS_MAIN["assets/css/main.scss"]
end
APP --> L_DEFAULT
L_DEFAULT --> P_INDEX
L_DEFAULT --> P_PROFILE
L_DEFAULT --> P_PUBLISH
P_LOGIN --> STORE_AUTH
P_REGISTER --> STORE_AUTH
P_PROFILE --> STORE_AUTH
P_PUBLISH --> STORE_AUTH
P_INDEX --> STORE_AUTH
P_INDEX --> COM_API
P_INDEX --> C_POSTCARD
P_PROFILE --> COM_API
P_PROFILE --> COM_FILE
P_PUBLISH --> COM_API
P_PUBLISH --> COM_FILE
STORE_AUTH --> COM_API
STORE_AUTH --> COM_FILE
STORE_AUTH --> COM_WS
NUXTCFG --> CSS_MAIN
PKG --> NUXTCFG
```

**图表来源**
- [app.vue](file://web_frontend/app.vue#L1-L17)
- [nuxt.config.ts](file://web_frontend/nuxt.config.ts#L1-L42)
- [layouts/default.vue](file://web_frontend/layouts/default.vue#L1-L87)
- [pages/index.vue](file://web_frontend/pages/index.vue#L1-L145)
- [pages/login.vue](file://web_frontend/pages/login.vue#L1-L139)
- [pages/register.vue](file://web_frontend/pages/register.vue#L1-L152)
- [pages/profile.vue](file://web_frontend/pages/profile.vue#L1-L309)
- [pages/publish.vue](file://web_frontend/pages/publish.vue#L1-L182)
- [stores/auth.ts](file://web_frontend/stores/auth.ts#L1-L80)
- [composables/useApi.ts](file://web_frontend/composables/useApi.ts#L1-L57)
- [composables/useFileUrl.ts](file://web_frontend/composables/useFileUrl.ts#L1-L28)
- [composables/useWebSocket.ts](file://web_frontend/composables/useWebSocket.ts#L1-L104)
- [components/PostCard.vue](file://web_frontend/components/PostCard.vue#L1-L183)
- [assets/css/main.scss](file://web_frontend/assets/css/main.scss#L1-L53)

**章节来源**
- [package.json](file://web_frontend/package.json#L1-L28)
- [nuxt.config.ts](file://web_frontend/nuxt.config.ts#L1-L42)
- [assets/css/main.scss](file://web_frontend/assets/css/main.scss#L1-L53)

## 核心组件
- 应用入口与初始化：在应用挂载时初始化认证状态并尝试拉取用户信息，确保页面渲染前具备必要的鉴权上下文。
- 认证状态管理：使用 Pinia Store 管理 Token 与用户信息，支持本地存储持久化、初始化恢复与登出清理。
- API 请求封装：统一处理 Content-Type、鉴权头、错误处理与空响应，提供 GET/POST/PUT/DELETE 方法。
- 文件 URL 处理：根据配置自动拼接完整 URL，兼容绝对路径与相对路径。
- WebSocket 管理：全局单例连接，自动心跳与断线重连，提供消息订阅接口。
- 页面组件：首页列表、登录注册表单、个人中心、发帖页面，均采用 Vant 组件与组合式函数实现。
- UI 组件：PostCard 负责帖子卡片渲染与交互，包含作者信息、内容、图片与操作区。

**章节来源**
- [app.vue](file://web_frontend/app.vue#L1-L17)
- [stores/auth.ts](file://web_frontend/stores/auth.ts#L1-L80)
- [composables/useApi.ts](file://web_frontend/composables/useApi.ts#L1-L57)
- [composables/useFileUrl.ts](file://web_frontend/composables/useFileUrl.ts#L1-L28)
- [composables/useWebSocket.ts](file://web_frontend/composables/useWebSocket.ts#L1-L104)
- [components/PostCard.vue](file://web_frontend/components/PostCard.vue#L1-L183)

## 架构总览
应用采用“页面 + 组合式函数 + 状态管理 + UI 组件”的分层架构。页面负责业务流程与 UI 呈现；组合式函数封装跨页面的通用逻辑；Pinia Store 管理认证与全局状态；Vant 提供移动端友好的 UI 基础。

```mermaid
graph TB
subgraph "视图层"
PAGE_INDEX["pages/index.vue"]
PAGE_PROFILE["pages/profile.vue"]
PAGE_PUBLISH["pages/publish.vue"]
PAGE_LOGIN["pages/login.vue"]
PAGE_REGISTER["pages/register.vue"]
LAYOUT_DEFAULT["layouts/default.vue"]
COMPONENT_POSTCARD["components/PostCard.vue"]
end
subgraph "逻辑层"
COM_USEAPI["composables/useApi.ts"]
COM_USEFILE["composables/useFileUrl.ts"]
COM_USEWS["composables/useWebSocket.ts"]
end
subgraph "状态层"
STORE_AUTH["stores/auth.ts"]
end
subgraph "运行时配置"
NUXTCFG["nuxt.config.ts"]
end
PAGE_INDEX --> STORE_AUTH
PAGE_INDEX --> COM_USEAPI
PAGE_INDEX --> COMPONENT_POSTCARD
PAGE_PROFILE --> STORE_AUTH
PAGE_PROFILE --> COM_USEAPI
PAGE_PROFILE --> COM_USEFILE
PAGE_PUBLISH --> STORE_AUTH
PAGE_PUBLISH --> COM_USEAPI
PAGE_PUBLISH --> COM_USEFILE
PAGE_LOGIN --> STORE_AUTH
PAGE_REGISTER --> STORE_AUTH
LAYOUT_DEFAULT --> STORE_AUTH
LAYOUT_DEFAULT --> COM_USEAPI
LAYOUT_DEFAULT --> COM_USEWS
STORE_AUTH --> COM_USEAPI
STORE_AUTH --> COM_USEFILE
STORE_AUTH --> COM_USEWS
NUXTCFG --> PAGE_INDEX
NUXTCFG --> PAGE_PROFILE
NUXTCFG --> PAGE_PUBLISH
NUXTCFG --> PAGE_LOGIN
NUXTCFG --> PAGE_REGISTER
```

**图表来源**
- [layouts/default.vue](file://web_frontend/layouts/default.vue#L1-L87)
- [pages/index.vue](file://web_frontend/pages/index.vue#L1-L145)
- [pages/profile.vue](file://web_frontend/pages/profile.vue#L1-L309)
- [pages/publish.vue](file://web_frontend/pages/publish.vue#L1-L182)
- [pages/login.vue](file://web_frontend/pages/login.vue#L1-L139)
- [pages/register.vue](file://web_frontend/pages/register.vue#L1-L152)
- [stores/auth.ts](file://web_frontend/stores/auth.ts#L1-L80)
- [composables/useApi.ts](file://web_frontend/composables/useApi.ts#L1-L57)
- [composables/useFileUrl.ts](file://web_frontend/composables/useFileUrl.ts#L1-L28)
- [composables/useWebSocket.ts](file://web_frontend/composables/useWebSocket.ts#L1-L104)
- [nuxt.config.ts](file://web_frontend/nuxt.config.ts#L1-L42)

## 详细组件分析

### 认证状态管理（Pinia）
- 数据模型：Token 与用户信息，提供登录态 getter。
- 关键动作：设置 Token（含本地存储）、设置用户、登出清理、初始化从本地恢复 Token、拉取当前用户信息。
- 与 API 集成：在拉取用户信息时携带 Bearer Token，并在失败时自动登出。

```mermaid
classDiagram
class AuthStore {
+string|null token
+User|null user
+isLoggedIn() boolean
+setToken(token) void
+setUser(user) void
+logout() void
+init() void
+fetchUser() Promise<void>
}
class User {
+number id
+string username
+string nickname
+string|null avatar_path
+string|null bio
+boolean is_ai
+string created_at
}
AuthStore --> User : "拥有"
```

**图表来源**
- [stores/auth.ts](file://web_frontend/stores/auth.ts#L1-L80)

**章节来源**
- [stores/auth.ts](file://web_frontend/stores/auth.ts#L1-L80)

### API 请求封装（useApi）
- 统一基地址：来自运行时配置的公共 API Base。
- 鉴权：可选携带 Token 到 Authorization 头。
- 错误处理：非 2xx 响应抛出错误，支持 204 空响应。
- 方法导出：get/post/put/delete。

```mermaid
sequenceDiagram
participant Page as "页面组件"
participant Api as "useApi"
participant Fetch as "fetch"
participant Store as "AuthStore"
Page->>Api : 调用 get/post...
Api->>Store : 读取 token可选
Api->>Fetch : 发起请求带头/体
Fetch-->>Api : Response 对象
Api->>Api : 校验状态码/解析JSON
Api-->>Page : 返回数据或抛出错误
```

**图表来源**
- [composables/useApi.ts](file://web_frontend/composables/useApi.ts#L1-L57)
- [stores/auth.ts](file://web_frontend/stores/auth.ts#L1-L80)

**章节来源**
- [composables/useApi.ts](file://web_frontend/composables/useApi.ts#L1-L57)

### 文件 URL 处理（useFileUrl）
- 规则：若为空返回空字符串；若为 http(s) 开头直接返回；若以 /files/ 开头或以 / 开头则拼接 API Base；否则原样返回。
- 用途：统一处理头像、图片等资源路径。

```mermaid
flowchart TD
Start(["开始"]) --> CheckEmpty["是否为空/未定义?"]
CheckEmpty --> |是| ReturnEmpty["返回空字符串"]
CheckEmpty --> |否| CheckHttp["是否以 http(s) 开头?"]
CheckHttp --> |是| ReturnFull["直接返回原路径"]
CheckHttp --> |否| CheckFiles["是否以 /files/ 开头?"]
CheckFiles --> |是| ConcatBase["拼接 API Base 并返回"]
CheckFiles --> |否| CheckSlash["是否以 / 开头?"]
CheckSlash --> |是| ConcatBase2["拼接 API Base 并返回"]
CheckSlash --> |否| ReturnPath["原样返回路径"]
```

**图表来源**
- [composables/useFileUrl.ts](file://web_frontend/composables/useFileUrl.ts#L1-L28)

**章节来源**
- [composables/useFileUrl.ts](file://web_frontend/composables/useFileUrl.ts#L1-L28)

### WebSocket 连接管理（useWebSocket）
- 单例模式：全局共享连接，避免重复实例。
- 自动重连：断开后定时重连，仅在存在 Token 时触发。
- 心跳：每 30 秒发送 ping，保持连接活跃。
- 消息订阅：提供 onMessage 订阅接口，内部维护处理器集合。

```mermaid
sequenceDiagram
participant Page as "页面/布局"
participant WS as "useWebSocket"
participant Server as "消息服务"
Page->>WS : connect()
WS->>Server : 建立 ws/wss 连接携带 token
Server-->>WS : onopen
WS->>WS : 启动心跳定时器
Server-->>WS : onmessage
WS->>WS : 解析消息/过滤 pong
WS-->>Page : 调用订阅处理器
Server-->>WS : onclose
WS->>WS : 清理定时器/设置断开
WS->>WS : 条件性定时重连
```

**图表来源**
- [composables/useWebSocket.ts](file://web_frontend/composables/useWebSocket.ts#L1-L104)

**章节来源**
- [composables/useWebSocket.ts](file://web_frontend/composables/useWebSocket.ts#L1-L104)

### 布局与导航（default.vue）
- 底部 TabBar：首页、私信、发帖、我的。
- 未读消息：通过 API 获取未读数并在消息 WebSocket 新消息到达时递增。
- 生命周期：登录态变化时刷新未读数并连接/断开 WebSocket。

```mermaid
sequenceDiagram
participant Layout as "default.vue"
participant API as "useApi"
participant WS as "useWebSocket"
participant Store as "AuthStore"
Layout->>API : 获取未读数
API-->>Layout : 未读数
Layout->>WS : connect()
WS-->>Layout : onMessage(new_message)
Layout->>Layout : 未读数+1
Layout->>Store : 监听登录态变化
Store-->>Layout : 登录/登出
Layout->>API : 登录态变化时刷新未读数
Layout->>WS : 登录时连接/登出时断开
```

**图表来源**
- [layouts/default.vue](file://web_frontend/layouts/default.vue#L1-L87)

**章节来源**
- [layouts/default.vue](file://web_frontend/layouts/default.vue#L1-L87)

### 首页（index.vue）
- 功能：下拉刷新、上拉加载、帖子列表、点赞交互。
- 交互：未登录拦截到登录页；点赞调用后端接口并更新本地状态。

```mermaid
sequenceDiagram
participant Index as "index.vue"
participant API as "useApi"
participant Store as "AuthStore"
Index->>API : 加载帖子列表
API-->>Index : 返回分页数据
Index->>Store : 点赞前检查登录态
Store-->>Index : 已登录
Index->>API : POST /posts/ : id/like
API-->>Index : 返回 liked/likes_count
Index->>Index : 更新本地帖子状态
```

**图表来源**
- [pages/index.vue](file://web_frontend/pages/index.vue#L1-L145)

**章节来源**
- [pages/index.vue](file://web_frontend/pages/index.vue#L1-L145)

### 登录页（login.vue）
- 表单校验：用户名/密码必填。
- 登录流程：使用表单数据向后端发起登录请求，成功后写入 Token 并拉取用户信息，提示成功并跳转首页。

```mermaid
sequenceDiagram
participant Login as "login.vue"
participant Fetch as "fetch"
participant Store as "AuthStore"
Login->>Fetch : POST /auth/login表单数据
Fetch-->>Login : 返回 access_token
Login->>Store : setToken(access_token)
Login->>Store : fetchUser()
Store-->>Login : 用户信息
Login-->>Login : 提示成功并跳转 /
```

**图表来源**
- [pages/login.vue](file://web_frontend/pages/login.vue#L1-L139)
- [stores/auth.ts](file://web_frontend/stores/auth.ts#L1-L80)

**章节来源**
- [pages/login.vue](file://web_frontend/pages/login.vue#L1-L139)

### 注册页（register.vue）
- 表单校验：用户名长度、昵称必填、密码长度、确认密码一致性。
- 注册流程：调用注册 API，成功后提示并跳转登录页。

**章节来源**
- [pages/register.vue](file://web_frontend/pages/register.vue#L1-L152)

### 个人中心（profile.vue）
- 未登录提示与按钮跳转。
- 已登录：展示用户信息卡片、统计数据占位、功能菜单、退出登录确认。
- 弹窗“我的帖子”：懒加载用户发布的帖子列表。

**章节来源**
- [pages/profile.vue](file://web_frontend/pages/profile.vue#L1-L309)

### 发布页（publish.vue）
- 内容输入与字数限制。
- 图片上传：选择图片后上传至文件服务，成功后记录图片路径。
- 发布：校验登录态与内容，提交后提示成功并返回首页。

**章节来源**
- [pages/publish.vue](file://web_frontend/pages/publish.vue#L1-L182)

### UI 组件：PostCard（components/PostCard.vue）
- 结构：作者头像与昵称、发布时间、正文、图片、点赞/评论/分享操作。
- 交互：点击卡片跳转详情；点赞事件向上抛出；时间格式化。
- 资源：使用 useFileUrl 处理头像与图片路径。

```mermaid
classDiagram
class PostCard {
+props Post post
+emits like(postId)
+goToDetail() void
+formatTime(timeStr) string
}
class Post {
+number id
+string content
+string|null image_path
+number author_id
+number likes_count
+string created_at
+Author author
+boolean is_liked
+number comments_count
}
class Author {
+number id
+string username
+string nickname
+string|null avatar_path
+boolean is_ai
}
PostCard --> Post : "接收"
Post --> Author : "包含"
```

**图表来源**
- [components/PostCard.vue](file://web_frontend/components/PostCard.vue#L1-L183)

**章节来源**
- [components/PostCard.vue](file://web_frontend/components/PostCard.vue#L1-L183)

## 依赖关系分析
- 构建与运行时：Nuxt 3、Vue 3、Pinia、Vant。
- 开发工具：DevTools、TypeScript、Sass。
- 运行时配置：公开 API Base，移动端 viewport 设置，全局 CSS 引入。

```mermaid
graph LR
PKG["package.json"] --> Nuxt["nuxt"]
PKG --> Vue["vue"]
PKG --> Router["vue-router"]
PKG --> Pinia["@pinia/nuxt + pinia"]
PKG --> Vant["@vant/nuxt + vant"]
NuxtCFG["nuxt.config.ts"] --> Modules["modules: @pinia/nuxt, @vant/nuxt"]
NuxtCFG --> CSS["css: vant + main.scss"]
NuxtCFG --> Runtime["runtimeConfig.public.apiBase"]
NuxtCFG --> AppHead["app.head: title + meta + viewport"]
NuxtCFG --> ViteCSS["vite.css.preprocessorOptions.scss"]
```

**图表来源**
- [package.json](file://web_frontend/package.json#L1-L28)
- [nuxt.config.ts](file://web_frontend/nuxt.config.ts#L1-L42)

**章节来源**
- [package.json](file://web_frontend/package.json#L1-L28)
- [nuxt.config.ts](file://web_frontend/nuxt.config.ts#L1-L42)

## 性能考虑
- 列表加载：首页采用分页加载与“到底加载更多”，避免一次性渲染大量数据。
- 本地存储：认证 Token 存储于 localStorage，减少每次刷新的鉴权往返。
- 资源路径：统一使用 useFileUrl，避免重复拼接与网络请求失败。
- WebSocket：单例连接与心跳维持，降低连接成本与异常风险。
- UI 交互：使用 Vant 组件，减少自定义复杂交互带来的性能负担。

## 故障排查指南
- 登录失败：检查后端登录接口返回的错误信息，确认用户名/密码正确与网络可达。
- 无法加载帖子：检查 API Base 配置与网络代理，确认分页参数与权限。
- 图片上传失败：确认已登录且 Token 正确，检查文件大小与类型限制。
- WebSocket 不连：确认 Token 存在、URL 协议匹配（http->ws、https->wss），查看控制台错误日志。
- 未读消息不更新：确认消息服务推送与 onMessage 订阅正常，检查断线重连逻辑。

**章节来源**
- [pages/login.vue](file://web_frontend/pages/login.vue#L1-L139)
- [pages/index.vue](file://web_frontend/pages/index.vue#L1-L145)
- [pages/publish.vue](file://web_frontend/pages/publish.vue#L1-L182)
- [composables/useWebSocket.ts](file://web_frontend/composables/useWebSocket.ts#L1-L104)

## 结论
该前端应用以 Nuxt 3 为核心，结合 Pinia、Vant 与组合式函数，实现了清晰的分层架构与良好的移动端体验。通过统一的 API、文件 URL 与 WebSocket 封装，提升了可维护性与扩展性。建议后续完善国际化、主题切换与更细粒度的错误边界处理，持续优化首屏性能与离线能力。

## 附录
- 构建与预览命令：参见 package.json scripts。
- 运行时配置：API Base 可通过环境变量覆盖。
- 样式规范：全局 SCSS 定义变量与通用类，页面容器与卡片样式复用。

**章节来源**
- [package.json](file://web_frontend/package.json#L1-L28)
- [nuxt.config.ts](file://web_frontend/nuxt.config.ts#L15-L19)
- [assets/css/main.scss](file://web_frontend/assets/css/main.scss#L1-L53)