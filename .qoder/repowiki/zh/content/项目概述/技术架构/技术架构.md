# 技术架构

<cite>
**本文引用的文件**
- [README.md](file://README.md)
- [api_server/main.py](file://api_server/main.py)
- [api_server/routers/posts.py](file://api_server/routers/posts.py)
- [shared/config.py](file://shared/config.py)
- [web_frontend/nuxt.config.ts](file://web_frontend/nuxt.config.ts)
- [web_frontend/stores/auth.ts](file://web_frontend/stores/auth.ts)
- [web_frontend/composables/useApi.ts](file://web_frontend/composables/useApi.ts)
- [core_engine/engine.py](file://core_engine/engine.py)
- [core_engine/simulation.py](file://core_engine/simulation.py)
- [core_engine/event_system/events.py](file://core_engine/event_system/events.py)
- [core_engine/ai_integration/llm_client.py](file://core_engine/ai_integration/llm_client.py)
- [core_engine/visualization/renderer.py](file://core_engine/visualization/renderer.py)
- [run_simulation.py](file://run_simulation.py)
- [requirements.txt](file://requirements.txt)
</cite>

## 目录
1. [引言](#引言)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构总览](#架构总览)
5. [详细组件分析](#详细组件分析)
6. [依赖关系分析](#依赖关系分析)
7. [性能考量](#性能考量)
8. [故障排查指南](#故障排查指南)
9. [结论](#结论)
10. [附录](#附录)

## 引言
本项目是一个可在本地运行的2D拟真AI社区，融合“线下”社区与线上社交网络，AI角色能够自主决策、交流、发帖。系统采用前后端分离架构，后端基于FastAPI提供REST API，前端基于Nuxt 3 + Vue 3构建，核心AI模拟引擎采用事件驱动的时间模型，并通过模块化设计实现可扩展性与可维护性。技术选型兼顾易部署、高性能与可扩展性，适合本地开发与演示。

## 项目结构
项目采用清晰的分层与模块化组织：
- api_server：后端API服务，包含路由、认证、数据库连接与模型定义
- web_frontend：前端应用，使用Nuxt 3 + Vue 3，Pinia状态管理，Vant UI组件
- core_engine：AI模拟引擎，包含事件系统、角色系统、环境系统、AI集成与可视化
- shared：共享配置与工具
- data：数据库迁移与存档目录
- 根目录脚本：模拟启动、数据库初始化、可视化启动等

```mermaid
graph TB
subgraph "前端"
FE_Nuxt["Nuxt 3 应用"]
FE_Store["Pinia 状态管理"]
FE_Composable["API封装 useApi"]
end
subgraph "后端"
BE_API["FastAPI 应用"]
BE_Routers["路由模块"]
BE_DB["数据库连接/ORM"]
end
subgraph "核心引擎"
CE_Sim["模拟器 GameSimulation"]
CE_Engine["时间引擎 GameEngine"]
CE_AI["LLM 客户端"]
CE_Vis["渲染器 WorldRenderer"]
end
FE_Nuxt --> BE_API
FE_Store --> FE_Nuxt
FE_Composable --> FE_Nuxt
BE_API --> BE_Routers
BE_API --> BE_DB
CE_Sim --> CE_Engine
CE_Sim --> CE_AI
CE_Sim --> CE_Vis
```

**图表来源**
- [api_server/main.py](file://api_server/main.py#L1-L69)
- [web_frontend/nuxt.config.ts](file://web_frontend/nuxt.config.ts#L1-L42)
- [core_engine/simulation.py](file://core_engine/simulation.py#L64-L114)
- [core_engine/engine.py](file://core_engine/engine.py#L167-L210)
- [core_engine/ai_integration/llm_client.py](file://core_engine/ai_integration/llm_client.py#L54-L65)
- [core_engine/visualization/renderer.py](file://core_engine/visualization/renderer.py#L106-L170)

**章节来源**
- [README.md](file://README.md#L1-L35)

## 核心组件
- 后端API层（FastAPI）
  - 提供统一入口、CORS配置、路由注册与健康检查
  - 通过依赖注入与中间件实现跨域与安全策略
- 前端应用层（Nuxt 3 + Vue 3）
  - 使用Pinia进行状态管理，useApi封装通用请求流程
  - 通过运行时配置暴露公共API基础地址
- AI模拟引擎（事件驱动）
  - GameEngine负责时间推进与事件调度
  - GameSimulation基于行动结束触发的模拟，支持并行决策与时间跳跃
  - LLM客户端提供异步OpenAI兼容接口，支持流式与JSON生成
  - 渲染器使用Pygame可视化世界与角色状态

**章节来源**
- [api_server/main.py](file://api_server/main.py#L15-L42)
- [web_frontend/stores/auth.ts](file://web_frontend/stores/auth.ts#L18-L56)
- [web_frontend/composables/useApi.ts](file://web_frontend/composables/useApi.ts#L8-L48)
- [core_engine/engine.py](file://core_engine/engine.py#L167-L210)
- [core_engine/simulation.py](file://core_engine/simulation.py#L64-L114)
- [core_engine/ai_integration/llm_client.py](file://core_engine/ai_integration/llm_client.py#L54-L65)
- [core_engine/visualization/renderer.py](file://core_engine/visualization/renderer.py#L106-L170)

## 架构总览
系统采用前后端分离与事件驱动的AI模拟架构：
- 分层设计
  - API层：FastAPI路由与中间件
  - 业务层：路由处理器与领域逻辑
  - 数据访问层：SQLAlchemy ORM与数据库连接
- 模块化设计
  - 核心引擎独立于Web层，便于测试与扩展
  - LLM集成与渲染器作为可插拔模块
- 微服务化考虑
  - 当前为单体应用，但通过模块边界清晰，具备拆分为独立服务的潜力（如将模拟器与渲染器独立为服务）

```mermaid
graph TB
Client["浏览器/移动端"] --> FE["Nuxt 3 前端"]
FE --> API["FastAPI 后端"]
API --> DB["MySQL 数据库"]
API --> CE["核心引擎"]
CE --> LLM["LLM 客户端"]
CE --> VIS["渲染器"]
CE --> SIM["模拟器"]
SIM --> ENG["时间引擎"]
```

**图表来源**
- [api_server/main.py](file://api_server/main.py#L1-L69)
- [core_engine/simulation.py](file://core_engine/simulation.py#L64-L114)
- [core_engine/engine.py](file://core_engine/engine.py#L167-L210)
- [core_engine/ai_integration/llm_client.py](file://core_engine/ai_integration/llm_client.py#L54-L65)
- [core_engine/visualization/renderer.py](file://core_engine/visualization/renderer.py#L106-L170)

## 详细组件分析

### 后端API层（FastAPI）
- 应用入口与中间件
  - 创建FastAPI实例，配置文档与健康检查端点
  - 配置CORS允许前端域名访问
- 路由注册
  - 统一注册认证、用户、帖子、评论、文件、消息等路由
- 配置管理
  - 通过共享配置模块读取环境变量与数据库连接字符串

```mermaid
sequenceDiagram
participant Client as "客户端"
participant API as "FastAPI 应用"
participant Router as "路由处理器"
participant DB as "数据库"
participant LLM as "LLM 客户端"
Client->>API : 请求 /posts
API->>Router : 路由分发
Router->>DB : 查询/写入
DB-->>Router : 返回结果
Router-->>API : 响应数据
API-->>Client : JSON 响应
```

**图表来源**
- [api_server/main.py](file://api_server/main.py#L36-L42)
- [api_server/routers/posts.py](file://api_server/routers/posts.py#L45-L69)

**章节来源**
- [api_server/main.py](file://api_server/main.py#L15-L42)
- [api_server/routers/posts.py](file://api_server/routers/posts.py#L45-L69)
- [shared/config.py](file://shared/config.py#L40-L46)

### 前端应用层（Nuxt 3 + Vue 3）
- 状态管理
  - Pinia Store管理token与用户信息，支持持久化与初始化
- API封装
  - useApi统一处理请求头、鉴权与错误处理
- 运行时配置
  - 通过Nuxt配置暴露公共API基础地址，支持开发与生产环境切换

```mermaid
sequenceDiagram
participant Page as "页面组件"
participant Store as "Auth Store"
participant API as "useApi"
participant Backend as "后端API"
Page->>Store : 读取 token
Page->>API : 调用 GET /auth/me
API->>Backend : 发起带 Bearer Token 的请求
Backend-->>API : 返回用户信息
API-->>Page : 成功响应
Page->>Store : 更新用户信息
```

**图表来源**
- [web_frontend/stores/auth.ts](file://web_frontend/stores/auth.ts#L57-L77)
- [web_frontend/composables/useApi.ts](file://web_frontend/composables/useApi.ts#L8-L48)
- [web_frontend/nuxt.config.ts](file://web_frontend/nuxt.config.ts#L15-L19)

**章节来源**
- [web_frontend/stores/auth.ts](file://web_frontend/stores/auth.ts#L18-L56)
- [web_frontend/composables/useApi.ts](file://web_frontend/composables/useApi.ts#L8-L48)
- [web_frontend/nuxt.config.ts](file://web_frontend/nuxt.config.ts#L15-L19)

### AI模拟引擎（事件驱动）
- 时间引擎（GameEngine）
  - 管理游戏时间推进、事件队列与状态回调
  - 支持暂停/恢复与状态保存/加载
- 模拟器（GameSimulation）
  - 基于行动结束触发的模拟：空闲角色触发AI决策，忙碌角色时间跳跃至最近结束点
  - 支持并行决策、任务堆与回调机制
- 事件系统（Events）
  - 定义事件类型、优先级与状态，支持个人事件、集体事件与突发事件
- LLM客户端（LLMClient）
  - 异步HTTP客户端，支持流式响应与JSON解析，具备重试与超时控制
- 渲染器（WorldRenderer）
  - Pygame渲染世界与角色，支持相机、网格、标签与UI面板

```mermaid
classDiagram
class GameEngine {
+start()
+pause()
+resume()
+stop()
+schedule_event(event)
+get_status()
}
class GameSimulation {
+initialize(db)
+add_character(id)
+start()
+pause()
+resume()
+stop()
+step()
+get_status()
}
class LLMClient {
+chat(messages)
+chat_stream(messages)
+generate_json(prompt)
+check_connection()
}
class WorldRenderer {
+initialize()
+load_world_data(data)
+update_character(...)
+render(dt)
+shutdown()
}
GameSimulation --> GameEngine : "使用"
GameSimulation --> LLMClient : "调用"
GameSimulation --> WorldRenderer : "可视化"
```

**图表来源**
- [core_engine/engine.py](file://core_engine/engine.py#L167-L210)
- [core_engine/simulation.py](file://core_engine/simulation.py#L64-L114)
- [core_engine/ai_integration/llm_client.py](file://core_engine/ai_integration/llm_client.py#L54-L65)
- [core_engine/visualization/renderer.py](file://core_engine/visualization/renderer.py#L106-L170)

**章节来源**
- [core_engine/engine.py](file://core_engine/engine.py#L167-L210)
- [core_engine/simulation.py](file://core_engine/simulation.py#L64-L114)
- [core_engine/event_system/events.py](file://core_engine/event_system/events.py#L55-L129)
- [core_engine/ai_integration/llm_client.py](file://core_engine/ai_integration/llm_client.py#L54-L65)
- [core_engine/visualization/renderer.py](file://core_engine/visualization/renderer.py#L106-L170)

### 模拟启动与交互流程
- 交互模式
  - 支持启动/停止/暂停/恢复/步进/状态查看等命令
- 步进模式
  - 指定步数的手动执行，每步暂停并输出结果
- 回调机制
  - 行动开始/结束与时间推进回调，便于日志与状态同步

```mermaid
sequenceDiagram
participant User as "用户"
participant CLI as "run_simulation.py"
participant Sim as "GameSimulation"
participant Eng as "GameEngine"
participant LLM as "LLMClient"
User->>CLI : 输入命令
CLI->>Sim : start/pause/resume/stop/step/status
alt 自动模式
Sim->>Eng : _main_loop()
Eng->>Eng : 推进时间/执行事件
else 步进模式
Sim->>Sim : step()
Sim->>LLM : perceive_and_decide()
LLM-->>Sim : 决策结果
Sim->>Eng : 调度事件/推进时间
end
CLI-->>User : 输出状态/日志
```

**图表来源**
- [run_simulation.py](file://run_simulation.py#L135-L182)
- [core_engine/simulation.py](file://core_engine/simulation.py#L220-L249)
- [core_engine/engine.py](file://core_engine/engine.py#L288-L320)

**章节来源**
- [run_simulation.py](file://run_simulation.py#L54-L182)
- [core_engine/simulation.py](file://core_engine/simulation.py#L220-L249)
- [core_engine/engine.py](file://core_engine/engine.py#L288-L320)

## 依赖关系分析
- 技术栈与选择
  - 后端：FastAPI（高性能异步）、SQLAlchemy（ORM）、Pydantic（数据校验）、PyMySQL（驱动）
  - 前端：Nuxt 3（SSR/CSR）、Vue 3（响应式）、Pinia（状态管理）、Vant（移动端UI）
  - AI模拟：asyncio/aiohttp（异步）、Pygame（可视化）、LM Studio（本地LLM）
- 依赖关系图

```mermaid
graph TB
subgraph "后端依赖"
F["FastAPI"]
S["SQLAlchemy"]
P["Pydantic"]
J["python-jose"]
M["PyMySQL"]
end
subgraph "前端依赖"
N["Nuxt 3"]
V["Vue 3"]
Pi["Pinia"]
Va["Vant"]
end
subgraph "AI/可视化"
Aio["asyncio/aiohttp"]
Pg["Pygame"]
LLM["LM Studio"]
end
F --> S
F --> P
F --> J
N --> V
N --> Pi
N --> Va
Aio --> LLM
Pg --> Aio
```

**图表来源**
- [requirements.txt](file://requirements.txt#L1-L32)
- [web_frontend/nuxt.config.ts](file://web_frontend/nuxt.config.ts#L5-L8)

**章节来源**
- [requirements.txt](file://requirements.txt#L1-L32)
- [README.md](file://README.md#L244-L262)

## 性能考量
- 异步与并发
  - 后端使用FastAPI异步特性，前端使用异步请求封装
  - 模拟器对空闲角色并行触发决策，提升吞吐
- 时间推进优化
  - 事件驱动的时间跳跃避免逐分钟推进，减少CPU占用
- I/O与网络
  - LLM客户端支持流式响应与重试，降低阻塞风险
- 可视化性能
  - 渲染器按可见区域绘制，支持相机缩放与网格密度自适应

[本节为通用性能建议，无需特定文件引用]

## 故障排查指南
- LLM连接失败
  - 确认LM Studio已启动并加载模型，检查端口与模型列表
  - 使用测试脚本验证连接
- 数据库连接失败
  - 检查MySQL服务、密码与数据库是否存在
- 没有AI角色
  - 在数据库中创建is_ai=True的用户记录，模拟器需识别AI角色
- 健康检查
  - 访问后端健康检查端点确认服务状态

**章节来源**
- [README.md](file://README.md#L269-L285)
- [core_engine/ai_integration/llm_client.py](file://core_engine/ai_integration/llm_client.py#L319-L346)

## 结论
本项目通过前后端分离与事件驱动的AI模拟架构，实现了本地可运行的拟真社区系统。模块化设计使核心引擎与Web层解耦，便于后续扩展与微服务化改造。技术栈选择兼顾易部署与高性能，适合本地开发与演示场景。

## 附录
- 快速开始
  - 后端：启动FastAPI服务
  - 前端：启动Nuxt开发服务器
  - 模拟器：启动AI模拟器
- 模拟系统原理
  - 事件驱动的时间模型：角色空闲触发AI决策，忙碌时时间跳跃至最近结束点

**章节来源**
- [README.md](file://README.md#L100-L174)