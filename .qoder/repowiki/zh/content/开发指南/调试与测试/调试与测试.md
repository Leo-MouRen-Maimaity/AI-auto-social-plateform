# 调试与测试

<cite>
**本文引用的文件**
- [README.md](file://README.md)
- [requirements.txt](file://requirements.txt)
- [test_social.py](file://test_social.py)
- [run_simulation.py](file://run_simulation.py)
- [run_visualization.py](file://run_visualization.py)
- [api_server/main.py](file://api_server/main.py)
- [api_server/database.py](file://api_server/database.py)
- [api_server/models.py](file://api_server/models.py)
- [api_server/schemas.py](file://api_server/schemas.py)
- [shared/config.py](file://shared/config.py)
- [core_engine/engine.py](file://core_engine/engine.py)
- [core_engine/simulation.py](file://core_engine/simulation.py)
- [core_engine/ai_integration/llm_client.py](file://core_engine/ai_integration/llm_client.py)
- [core_engine/social/social_client.py](file://core_engine/social/social_client.py)
- [core_engine/social/social_scheduler.py](file://core_engine/social/social_scheduler.py)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构总览](#架构总览)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排查指南](#故障排查指南)
9. [结论](#结论)
10. [附录](#附录)

## 简介
本指南面向AI社区项目的开发者，提供一套系统化的调试与测试方法论，涵盖：
- 调试技巧与工具：Python调试器、浏览器开发者工具、日志分析
- 单元测试与集成测试：pytest使用、Mock对象、测试用例设计
- API测试、数据库测试与端到端测试策略
- 性能测试与基准测试
- 错误处理与异常捕获最佳实践
- 测试数据准备与清理
- 常见问题的调试案例与解决方案

## 项目结构
项目采用分层架构：后端API（FastAPI）、前端（Nuxt 3）、核心引擎（事件驱动模拟）、共享配置与数据库模型。测试覆盖范围包括社交功能、模拟器、可视化以及LLM客户端。

```mermaid
graph TB
subgraph "后端API"
A_main["api_server/main.py"]
A_db["api_server/database.py"]
A_models["api_server/models.py"]
A_schemas["api_server/schemas.py"]
end
subgraph "核心引擎"
E_engine["core_engine/engine.py"]
E_sim["core_engine/simulation.py"]
E_llm["core_engine/ai_integration/llm_client.py"]
E_soc_cli["core_engine/social/social_client.py"]
E_soc_sch["core_engine/social/social_scheduler.py"]
end
subgraph "前端"
F_run["run_visualization.py"]
end
subgraph "共享配置"
S_cfg["shared/config.py"]
end
A_main --> A_models
A_main --> A_schemas
A_main --> A_db
A_db --> A_models
E_sim --> E_engine
E_soc_sch --> E_soc_cli
E_soc_sch --> E_llm
F_run --> A_models
S_cfg --> A_main
S_cfg --> A_db
```

图表来源
- [api_server/main.py](file://api_server/main.py#L1-L69)
- [api_server/database.py](file://api_server/database.py#L1-L33)
- [api_server/models.py](file://api_server/models.py#L1-L293)
- [api_server/schemas.py](file://api_server/schemas.py#L1-L166)
- [core_engine/engine.py](file://core_engine/engine.py#L1-L429)
- [core_engine/simulation.py](file://core_engine/simulation.py#L1-L529)
- [core_engine/ai_integration/llm_client.py](file://core_engine/ai_integration/llm_client.py#L1-L351)
- [core_engine/social/social_client.py](file://core_engine/social/social_client.py#L1-L598)
- [core_engine/social/social_scheduler.py](file://core_engine/social/social_scheduler.py#L1-L735)
- [run_visualization.py](file://run_visualization.py#L1-L439)
- [shared/config.py](file://shared/config.py#L1-L52)

章节来源
- [README.md](file://README.md#L1-L290)
- [requirements.txt](file://requirements.txt#L1-L32)

## 核心组件
- API服务：FastAPI应用，注册路由、CORS配置、健康检查端点
- 数据库：SQLAlchemy引擎与会话工厂，模型定义与枚举
- 共享配置：统一读取环境变量，构造数据库URL
- 模拟引擎：事件驱动的时间推进与状态管理
- 社交调度：AI角色的社交行为编排（浏览、发帖、点赞、评论、私聊、相遇）
- LLM客户端：异步OpenAI兼容接口，支持流式与JSON生成
- 可视化：Pygame渲染世界、角色与行动日志

章节来源
- [api_server/main.py](file://api_server/main.py#L1-L69)
- [api_server/database.py](file://api_server/database.py#L1-L33)
- [api_server/models.py](file://api_server/models.py#L1-L293)
- [api_server/schemas.py](file://api_server/schemas.py#L1-L166)
- [shared/config.py](file://shared/config.py#L1-L52)
- [core_engine/engine.py](file://core_engine/engine.py#L1-L429)
- [core_engine/simulation.py](file://core_engine/simulation.py#L1-L529)
- [core_engine/ai_integration/llm_client.py](file://core_engine/ai_integration/llm_client.py#L1-L351)
- [core_engine/social/social_client.py](file://core_engine/social/social_client.py#L1-L598)
- [core_engine/social/social_scheduler.py](file://core_engine/social/social_scheduler.py#L1-L735)
- [run_visualization.py](file://run_visualization.py#L1-L439)

## 架构总览
后端通过FastAPI提供REST API，前端通过Nuxt 3访问；核心引擎通过事件队列驱动模拟，社交调度器协调AI角色行为，LLM客户端提供语言模型能力；可视化模块从数据库加载数据进行渲染。

```mermaid
graph TB
FE["前端(Nuxt 3)"] --> API["后端(FastAPI)"]
API --> DB["数据库(MySQL)"]
API --> LLM["LLM客户端(aiohttp)"]
SIM["模拟器(事件驱动)"] --> DB
SIM --> LLM
VIS["可视化(Pygame)"] --> DB
CFG["共享配置(.env/settings)"] --> API
CFG --> SIM
CFG --> VIS
```

图表来源
- [api_server/main.py](file://api_server/main.py#L1-L69)
- [api_server/database.py](file://api_server/database.py#L1-L33)
- [core_engine/simulation.py](file://core_engine/simulation.py#L1-L529)
- [core_engine/ai_integration/llm_client.py](file://core_engine/ai_integration/llm_client.py#L1-L351)
- [run_visualization.py](file://run_visualization.py#L1-L439)
- [shared/config.py](file://shared/config.py#L1-L52)

## 详细组件分析

### 组件A：社交功能测试脚本
该脚本演示了如何直接调用社交客户端与调度器，进行发帖、点赞、评论、私聊、线下相遇等行为测试。适合集成测试与端到端场景。

```mermaid
sequenceDiagram
participant T as "测试脚本(test_social.py)"
participant SC as "社交客户端(SocialClient)"
participant SS as "社交调度器(SocialScheduler)"
participant DB as "数据库(SQLAlchemy)"
participant LLM as "LLM客户端(LLMClient)"
T->>SC : 获取AI角色/最新帖子
T->>SS : 浏览动态/发帖/点赞/评论
SS->>SC : 查询/写入帖子/点赞/评论
SS->>LLM : 生成内容/回复(可选)
LLM-->>SS : 返回生成结果
SS-->>T : 返回行为结果
T->>DB : 读取/写入用户/帖子/评论/消息
```

图表来源
- [test_social.py](file://test_social.py#L1-L311)
- [core_engine/social/social_client.py](file://core_engine/social/social_client.py#L1-L598)
- [core_engine/social/social_scheduler.py](file://core_engine/social/social_scheduler.py#L1-L735)
- [core_engine/ai_integration/llm_client.py](file://core_engine/ai_integration/llm_client.py#L1-L351)
- [api_server/database.py](file://api_server/database.py#L1-L33)

章节来源
- [test_social.py](file://test_social.py#L1-L311)

### 组件B：模拟器与引擎（事件驱动）
模拟器基于“行动结束触发”模型，空闲角色决策行动，忙碌角色导致时间跳跃。引擎负责时间推进、事件队列与回调。

```mermaid
flowchart TD
Start(["开始模拟"]) --> Idle["查找空闲角色"]
Idle --> |有空闲| Decide["触发决策(perceive_and_decide)"]
Decide --> Task["创建任务(AgentTask)<br/>记录开始/结束时间"]
Task --> Exec["执行行动(execute_action)"]
Exec --> CallbackStart["触发on_action_start回调"]
CallbackStart --> BusyCheck{"全部忙碌?"}
BusyCheck --> |否| Idle
BusyCheck --> |是| Advance["推进到最近任务结束"]
Advance --> Complete["处理已完成任务"]
Complete --> CallbackEnd["触发on_action_end回调"]
CallbackEnd --> Idle
Idle --> |无空闲| Wait["短暂等待"]
Wait --> Idle
```

图表来源
- [core_engine/simulation.py](file://core_engine/simulation.py#L220-L478)
- [core_engine/engine.py](file://core_engine/engine.py#L288-L382)

章节来源
- [core_engine/simulation.py](file://core_engine/simulation.py#L1-L529)
- [core_engine/engine.py](file://core_engine/engine.py#L1-L429)

### 组件C：LLM客户端（异步OpenAI兼容）
LLM客户端封装异步HTTP请求，支持连接检查、模型列表获取、聊天、流式响应与JSON生成，并内置重试与超时控制。

```mermaid
classDiagram
class LLMConfig {
+string base_url
+string model
+float temperature
+int max_tokens
+float top_p
+int timeout
+int max_retries
+float retry_delay
}
class Message {
+string role
+string content
+to_dict() Dict
}
class LLMResponse {
+string content
+string finish_reason
+int prompt_tokens
+int completion_tokens
+int total_tokens
+string model
+success bool
}
class LLMClient {
-aiohttp.ClientSession _session
-bool _connected
+check_connection() bool
+get_available_models() string[]
+chat(messages, temperature, max_tokens, stop) LLMResponse
+chat_stream(messages, temperature, max_tokens) AsyncGenerator
+generate_with_system(system_prompt, user_prompt, temperature, max_tokens) LLMResponse
+generate_json(system_prompt, user_prompt, temperature) Dict?
+close() void
}
LLMClient --> LLMConfig : "使用"
LLMClient --> Message : "构建消息"
LLMClient --> LLMResponse : "返回响应"
```

图表来源
- [core_engine/ai_integration/llm_client.py](file://core_engine/ai_integration/llm_client.py#L14-L351)

章节来源
- [core_engine/ai_integration/llm_client.py](file://core_engine/ai_integration/llm_client.py#L1-L351)

### 组件D：社交调度器（行为编排）
社交调度器协调AI角色的社交行为：浏览动态、发帖、点赞、评论、私聊、主动发消息、线下相遇等。通过LLM生成内容与回复。

```mermaid
sequenceDiagram
participant SCH as "SocialScheduler"
participant AG as "CharacterAgent"
participant CLI as "SocialClient"
participant DB as "数据库"
participant LLM as "LLMClient"
SCH->>CLI : 获取最新帖子/用户/消息
SCH->>AG : browse_feed()/create_post()/start_conversation()
AG->>LLM : generate_with_system()/generate_json()
LLM-->>AG : 生成内容
SCH->>CLI : 点赞/评论/发私信/发帖
CLI->>DB : 写入帖子/评论/消息
CLI-->>SCH : 返回结果
```

图表来源
- [core_engine/social/social_scheduler.py](file://core_engine/social/social_scheduler.py#L1-L735)
- [core_engine/social/social_client.py](file://core_engine/social/social_client.py#L1-L598)
- [core_engine/ai_integration/llm_client.py](file://core_engine/ai_integration/llm_client.py#L1-L351)

章节来源
- [core_engine/social/social_scheduler.py](file://core_engine/social/social_scheduler.py#L1-L735)
- [core_engine/social/social_client.py](file://core_engine/social/social_client.py#L1-L598)

### 组件E：API服务与数据库
API服务注册路由、CORS与健康检查；数据库模块提供引擎与会话工厂；模型定义了用户、帖子、评论、消息、位置、事件、库存、行动日志等实体。

```mermaid
graph LR
M["api_server/main.py"] --> R["路由(auth/users/posts/comments/files/messages)"]
M --> CORS["CORS配置"]
DB["api_server/database.py"] --> ENG["SQLAlchemy引擎"]
DB --> SESS["SessionLocal"]
MODELS["api_server/models.py"] --> ENT["用户/帖子/评论/消息/位置/事件/库存/行动日志"]
SCHEMA["api_server/schemas.py"] --> PYD["Pydantic模型"]
```

图表来源
- [api_server/main.py](file://api_server/main.py#L1-L69)
- [api_server/database.py](file://api_server/database.py#L1-L33)
- [api_server/models.py](file://api_server/models.py#L1-L293)
- [api_server/schemas.py](file://api_server/schemas.py#L1-L166)

章节来源
- [api_server/main.py](file://api_server/main.py#L1-L69)
- [api_server/database.py](file://api_server/database.py#L1-L33)
- [api_server/models.py](file://api_server/models.py#L1-L293)
- [api_server/schemas.py](file://api_server/schemas.py#L1-L166)

## 依赖分析
- Python依赖集中在requirements.txt，包含FastAPI、SQLAlchemy、PyMySQL、Pydantic、aiohttp、Pillow、python-dotenv等
- API服务依赖共享配置读取数据库URL与JWT等参数
- 模拟器与社交调度器依赖LLM客户端进行内容生成
- 可视化模块依赖Pygame与数据库模型

```mermaid
graph TB
REQ["requirements.txt"] --> FAST["FastAPI"]
REQ --> SQL["SQLAlchemy"]
REQ --> PYMSQL["PyMySQL"]
REQ --> PYD["Pydantic"]
REQ --> AIO["aiohttp"]
REQ --> PIL["Pillow"]
REQ --> ENV["python-dotenv"]
CFG["shared/config.py"] --> DBURL["数据库URL"]
CFG --> JWT["JWT配置"]
CFG --> API["API主机/端口"]
API_MAIN["api_server/main.py"] --> CFG
API_DB["api_server/database.py"] --> DBURL
API_MODELS["api_server/models.py"] --> SQL
SIM["core_engine/simulation.py"] --> LLM["core_engine/ai_integration/llm_client.py"]
VIS["run_visualization.py"] --> API_MODELS
```

图表来源
- [requirements.txt](file://requirements.txt#L1-L32)
- [shared/config.py](file://shared/config.py#L1-L52)
- [api_server/main.py](file://api_server/main.py#L1-L69)
- [api_server/database.py](file://api_server/database.py#L1-L33)
- [api_server/models.py](file://api_server/models.py#L1-L293)
- [core_engine/simulation.py](file://core_engine/simulation.py#L1-L529)
- [core_engine/ai_integration/llm_client.py](file://core_engine/ai_integration/llm_client.py#L1-L351)
- [run_visualization.py](file://run_visualization.py#L1-L439)

章节来源
- [requirements.txt](file://requirements.txt#L1-L32)
- [shared/config.py](file://shared/config.py#L1-L52)

## 性能考虑
- 异步I/O：LLM客户端与API均采用异步HTTP，减少阻塞
- 事件驱动：模拟器按事件推进，避免轮询
- 数据库连接池：SQLAlchemy配置pool_pre_ping与pool_recycle，提升稳定性
- 可视化帧率：固定60FPS，模拟时间按秒推进，避免高负载
- 日志级别：模拟器verbose开关控制日志量，生产环境建议关闭

章节来源
- [core_engine/ai_integration/llm_client.py](file://core_engine/ai_integration/llm_client.py#L66-L78)
- [api_server/database.py](file://api_server/database.py#L14-L21)
- [run_visualization.py](file://run_visualization.py#L378-L422)
- [core_engine/simulation.py](file://core_engine/simulation.py#L504-L508)

## 故障排查指南
- LLM连接失败
  - 确认LM Studio已启动且监听端口1234
  - 使用测试脚本验证连接与模型列表
  - 检查网络与防火墙
- 数据库连接失败
  - 确认MySQL服务运行
  - 检查凭据与数据库名
  - 使用SQLAlchemy引擎连接测试
- 没有AI角色
  - 在数据库插入is_ai=True的用户记录
  - 确认模拟器加载AI角色
- 可视化依赖缺失
  - 安装pygame
  - 确认数据库中有地点与角色数据
- 日志与回调
  - 模拟器verbose开启可输出详细日志
  - 回调函数中捕获异常，避免中断主循环

章节来源
- [README.md](file://README.md#L269-L286)
- [core_engine/ai_integration/llm_client.py](file://core_engine/ai_integration/llm_client.py#L80-L93)
- [api_server/database.py](file://api_server/database.py#L14-L21)
- [run_simulation.py](file://run_simulation.py#L31-L108)
- [run_visualization.py](file://run_visualization.py#L17-L23)

## 结论
本指南提供了从调试工具、日志分析到单元与集成测试的完整方法论，结合项目实际组件（LLM客户端、社交调度器、模拟器、API与数据库）给出可操作的实践建议。建议在开发流程中：
- 使用异步与事件驱动提升性能
- 通过Mock与隔离测试保证质量
- 以可视化与日志辅助定位问题
- 建立完善的测试数据准备与清理策略

## 附录

### 调试与测试清单
- Python调试器：断点、变量检查、调用栈
- 浏览器开发者工具：Network面板观察API请求/响应、Console日志
- 日志分析：模拟器verbose、回调异常打印、数据库事务日志
- 单元测试：pytest + Mock（LLM、数据库会话）
- 集成测试：社交功能测试脚本、API端到端
- 性能测试：基准LLM响应时间、模拟器步进耗时
- 错误处理：异常捕获、降级策略、重试机制
- 测试数据：初始化脚本、测试夹具、事务回滚

### 常见问题与解决方案
- LLM不可达：检查端口、模型、超时与重试
- 数据库连接异常：核对凭据、网络、连接池参数
- AI角色无行为：确认is_ai标志、决策超时、任务堆
- 前后端跨域：CORS允许源配置
- 可视化崩溃：依赖安装、演示数据回退

章节来源
- [README.md](file://README.md#L269-L286)
- [core_engine/ai_integration/llm_client.py](file://core_engine/ai_integration/llm_client.py#L136-L170)
- [api_server/main.py](file://api_server/main.py#L23-L34)
- [run_visualization.py](file://run_visualization.py#L17-L23)