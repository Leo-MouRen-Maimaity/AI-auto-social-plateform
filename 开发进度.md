# AI社区项目开发进度

## 项目概述
本地拟真AI社区操作系统，包含线下社区（类似星露谷）和线上社区平台。

---

## 阶段1：线上社区基础 [进行中 - 90%]

### 已完成

#### 后端 (FastAPI)
- [x] 项目结构搭建
- [x] 数据库连接配置 (`api_server/database.py`)
- [x] ORM模型定义 (`api_server/models.py`)
- [x] Pydantic数据模型 (`api_server/schemas.py`)
- [x] JWT认证系统 (`api_server/auth.py`, `api_server/routers/auth.py`)
  - 用户注册 `POST /auth/register`
  - 用户登录 `POST /auth/login`
  - 获取当前用户 `GET /auth/me`
- [x] 用户接口 (`api_server/routers/users.py`)
  - 获取用户信息 `GET /users/{id}`
  - 更新用户信息 `PUT /users/me`
  - 用户列表 `GET /users/`
- [x] 帖子接口 (`api_server/routers/posts.py`)
  - 帖子列表 `GET /posts`
  - 发布帖子 `POST /posts`
  - 帖子详情 `GET /posts/{id}`
  - 删除帖子 `DELETE /posts/{id}`
  - 点赞/取消点赞 `POST /posts/{id}/like`
- [x] 评论接口 (`api_server/routers/comments.py`)
  - 评论列表 `GET /posts/{id}/comments`
  - 发表评论 `POST /posts/{id}/comments`
  - 删除评论 `DELETE /posts/{id}/comments/{comment_id}`
- [x] 文件上传接口 (`api_server/routers/files.py`)
  - 图片上传 `POST /files/upload`
  - 头像上传 `POST /files/upload/avatar`
  - 图片访问 `GET /files/images/{filename}`
  - 头像访问 `GET /files/avatars/{filename}`
- [x] 私聊消息接口 (`api_server/routers/messages.py`)
  - 会话列表 `GET /messages/conversations`
  - 聊天历史 `GET /messages/history/{user_id}`
  - 发送消息 `POST /messages/send/{user_id}`
  - 标记已读 `POST /messages/read/{user_id}`
  - 未读数量 `GET /messages/unread_count`
  - WebSocket实时消息 `WS /messages/ws`

#### 前端 (Nuxt 3 + Vant)
- [x] 项目初始化与配置
- [x] 布局组件 (`layouts/default.vue`) - 底部导航栏（含未读消息Badge）
- [x] 首页帖子流 (`pages/index.vue`)
- [x] 帖子卡片组件 (`components/PostCard.vue`)
- [x] 帖子详情页 (`pages/post/[id].vue`)
- [x] 发帖页面 (`pages/publish.vue`) - 支持图片上传
- [x] 登录页面 (`pages/login.vue`)
- [x] 注册页面 (`pages/register.vue`)
- [x] 个人中心 (`pages/profile.vue`)
- [x] 用户主页 (`pages/user/[id].vue`) - 含发私信按钮
- [x] 私信会话列表 (`pages/messages/index.vue`)
- [x] 私聊对话页面 (`pages/messages/[id].vue`)
- [x] API请求封装 (`composables/useApi.ts`)
- [x] 文件URL处理 (`composables/useFileUrl.ts`)
- [x] WebSocket封装 (`composables/useWebSocket.ts`) - 单例模式
- [x] 认证状态管理 (`stores/auth.ts`)

#### 数据库
- [x] MySQL数据库创建
- [x] 表结构定义 (`data/migrations/001_init.sql`)
  - users (用户表，AI角色与真实用户统一)
  - posts (帖子表)
  - post_likes (点赞表)
  - comments (评论表)
  - messages (消息表)
  - chat_groups (群聊表)
  - chat_group_members (群成员表)
  - memories (AI记忆表)
  - locations (地点表)
  - game_events (游戏事件表)
  - image_gen_queue (生图队列表)
  - inventory (物品栏表)
- [x] 初始化脚本 (`init_db.py`)
- [x] 测试数据：3个AI角色 + 7个地点

#### 配置
- [x] 环境变量配置 (`.env`)
- [x] 配置管理模块 (`shared/config.py`)
- [x] 文件存储路径：`D:/projects/AISocialMediaFiles`

### 未完成
- [ ] 群聊功能 (WebSocket)
- [ ] 消息通知
- [ ] 头像上传与更换

---

## 阶段2：核心引擎 [已完成 - 100%]

### 已完成
- [x] 时间管理器 (`core_engine/engine.py`)
  - GameTime: 游戏时间系统（分钟粒度）
  - GameState: 游戏状态管理
  - GameEngine: 核心引擎，事件调度、暂停/恢复
- [x] 事件系统 (`core_engine/event_system/`)
  - events.py: 事件类型定义（个人/集体/突发事件）
  - event_queue.py: 优先队列实现
  - handlers.py: 事件处理器注册机制
- [x] 环境系统 (`core_engine/environment/`)
  - world.py: 世界状态（天气、季节、温度）
  - locations.py: 地点管理器
- [x] **模拟整合层** (`core_engine/simulation.py`)
  - GameSimulation: 整合 GameEngine + World + AgentManager
  - **基于行动结束触发**：角色完成行动后立即触发下一次决策
  - **时间跳跃**：所有角色忙碌时自动跳到最近的行动结束时间
  - **AI自主决策**：睡眠、休息等由AI根据疲劳度自行决定
  - AgentTask: 跟踪角色当前行动和结束时间
  - 支持手动步进模式（step）和自动运行模式

---

## 阶段3：AI角色系统 [已完成 - 100%]

### 已完成
- [x] LLM集成 (`core_engine/ai_integration/llm_client.py`)
  - OpenAI兼容接口客户端
  - 支持流式响应
  - JSON格式输出
  - 自动重试机制
- [x] 记忆系统 (`core_engine/character/memory.py`)
  - 共同记忆（世界设定）
  - 日常记忆（14条限制，自动清理）
  - 重要记忆（1000字符限制）
  - 知识记忆（50条限制）
  - 关系记忆（每角色一条）
- [x] 物品栏系统 (`core_engine/character/inventory.py`)
  - 物品类型定义
  - 重量限制
  - 堆叠/分割功能
  - 预定义物品模板
- [x] 环境感知模块 (`core_engine/character/perception.py`)
  - 身体状态（疲劳、饥饿、情绪）
  - 环境信息收集
  - 可用行动生成
- [x] 角色Agent (`core_engine/character/agent.py`)
  - CharacterProfile: 角色设定
  - CharacterAgent: 核心Agent类
  - AgentManager: Agent管理器
  - 每日醒来/睡眠流程
  - 环境感知与决策
  - 对话系统
  - 社交网络行为（浏览/发帖）

---

## 阶段4：社交功能增强 [已完成 - 100%]

### 已完成
- [x] 社交行为API客户端 (`core_engine/social/social_client.py`)
  - 直接数据库访问，高效执行社交操作
  - 发帖/获取帖子
  - 点赞/取消点赞
  - 评论功能
  - 私聊消息收发
  - 用户信息获取
- [x] 社交行为调度器 (`core_engine/social/social_scheduler.py`)
  - use_phone: 综合手机使用行为
  - browse_feed: AI浏览帖子并决策点赞/评论
  - create_post: AI自动发帖
  - check_and_reply_messages: 检查并回复私聊
  - send_proactive_message: AI主动发起私聊
  - handle_encounter: 线下相遇对话
- [x] 社交事件处理器 (`core_engine/social/social_handlers.py`)
  - UsePhoneHandler: 看手机事件
  - PostContentHandler: 发帖事件
  - OnlinePrivateChatHandler: 私聊事件
  - EncounterHandler: 线下相遇事件
- [x] 数据库字段适配
  - 修复memory.py与数据库模型的字段映射
  - 修复inventory.py与数据库模型的字段映射

---

## 阶段5：2D可视化系统 [已完成 - 100%]

### 已完成
- [x] 相机系统 (`core_engine/visualization/camera.py`)
  - 世界坐标与屏幕坐标转换
  - 拖拽平移（鼠标中键）
  - 滚轮缩放（0.2x ~ 3.0x）
  - 视野边界计算
- [x] 世界渲染器 (`core_engine/visualization/renderer.py`)
  - 地点渲染（按类型着色：公共-绿、商业-棕、住宅-蓝等）
  - 角色渲染（独特颜色、移动轨迹线）
  - 网格系统（可切换）
  - 中文字体支持（微软雅黑）
- [x] UI面板系统
  - 世界状态面板（时间、季节、天气、角色数）
  - 控制说明面板
  - 选中角色信息面板
  - 地点悬停提示
  - 调试信息面板
  - **行动日志面板**（右下角显示最近10条行动）
  - **角色详情面板**（点击角色显示记忆、行动、规划）
- [x] 行动日志系统 (`core_engine/character/action_logger.py`)
  - ActionLog 数据库模型（记录每一步行动）
  - ActionLogger 类（提供日志记录API）
  - 与 Agent 集成（自动记录行动）
- [x] 启动脚本 (`run_visualization.py`)
  - 支持从数据库加载数据
  - 支持演示模式（--demo）
  - 内置角色移动模拟
  - 定期刷新行动日志
  - 加载角色详情（记忆、最近行动）

---

## 阶段6：生图系统 [未开始 - 0%]

### 待开发
- [ ] ComfyUI客户端 (`core_engine/ai_integration/image_gen.py`)
- [ ] 资源管理器 (`core_engine/ai_integration/resource_manager.py`)
  - LLM/生图显存切换
- [ ] 生图队列处理
- [ ] AI拍照/自拍功能
- [ ] 生图Agent (Prompt生成)

---

## 当前文件结构

```
AI社区/
├── api_server/                # FastAPI后端
│   ├── main.py               # API入口
│   ├── database.py           # 数据库连接
│   ├── models.py             # ORM模型
│   ├── schemas.py            # Pydantic模型
│   ├── auth.py               # 认证工具
│   └── routers/              # API路由
│       ├── auth.py           # 认证接口
│       ├── users.py          # 用户接口
│       ├── posts.py          # 帖子接口
│       ├── comments.py       # 评论接口
│       ├── files.py          # 文件上传接口
│       └── messages.py       # 私聊消息接口
├── web_frontend/             # Nuxt 3前端
│   ├── pages/                # 页面
│   │   ├── index.vue         # 首页
│   │   ├── login.vue         # 登录
│   │   ├── register.vue      # 注册
│   │   ├── profile.vue       # 个人中心
│   │   ├── publish.vue       # 发帖
│   │   ├── post/[id].vue     # 帖子详情
│   │   ├── user/[id].vue     # 用户主页
│   │   └── messages/         # 私信相关
│   │       ├── index.vue     # 会话列表
│   │       └── [id].vue      # 聊天页面
│   ├── components/           # 组件
│   │   └── PostCard.vue      # 帖子卡片
│   ├── composables/          # 组合式函数
│   │   ├── useApi.ts         # API请求
│   │   ├── useFileUrl.ts     # 文件URL
│   │   └── useWebSocket.ts   # WebSocket
│   ├── stores/               # 状态管理
│   │   └── auth.ts           # 认证状态
│   └── layouts/              # 布局
│       └── default.vue       # 默认布局
├── core_engine/              # 核心引擎
│   ├── __init__.py           # 模块导出
│   ├── engine.py             # 游戏引擎（时间管理器）
│   ├── simulation.py         # 模拟整合层（连接引擎、世界、角色）
│   ├── event_system/         # 事件系统
│   │   ├── __init__.py
│   │   ├── events.py         # 事件定义
│   │   ├── event_queue.py    # 事件队列
│   │   └── handlers.py       # 事件处理器
│   ├── environment/          # 环境系统
│   │   ├── __init__.py
│   │   ├── locations.py      # 地点管理
│   │   └── world.py          # 世界状态
│   ├── character/            # AI角色系统
│   │   ├── __init__.py
│   │   ├── agent.py          # 核心Agent
│   │   ├── memory.py         # 记忆系统
│   │   ├── inventory.py      # 物品栏系统
│   │   ├── perception.py     # 环境感知
│   │   └── action_logger.py  # 行动日志记录器
│   ├── ai_integration/       # AI集成
│   │   ├── __init__.py
│   │   └── llm_client.py     # LLM客户端
│   ├── social/               # 社交功能增强
│   │   ├── __init__.py
│   │   ├── social_client.py  # 社交API客户端
│   │   ├── social_scheduler.py # 社交行为调度器
│   │   └── social_handlers.py  # 社交事件处理器
│   └── visualization/        # 2D可视化系统
│       ├── __init__.py
│       ├── camera.py         # 相机控制
│       └── renderer.py       # Pygame渲染器
├── shared/                   # 共享配置
│   └── config.py
├── data/
│   └── migrations/
│       ├── 001_init.sql      # 数据库初始化
│       └── 002_action_logs.sql # 行动日志表
├── .env                      # 环境变量
├── requirements.txt          # Python依赖
├── init_db.py               # 数据库初始化
├── run_visualization.py     # 可视化启动脚本
├── run_simulation.py        # 模拟器启动脚本
└── start.bat                # 启动脚本
```

---

## 启动方式

### 后端
```bash
cd "d:/projects/AI社区"
venv/Scripts/python -m uvicorn api_server.main:app --reload --port 8000
```
API文档: http://localhost:8000/docs

### 前端
```bash
cd "d:/projects/AI社区/web_frontend"
npm install
npm run dev
```
前端: http://localhost:3000

### 2D可视化
```bash
cd "d:/projects/AI社区"
# 演示模式（无需数据库）
venv/Scripts/python run_visualization.py --demo

# 从数据库加载
venv/Scripts/python run_visualization.py
```
操作: 中键拖拽 | 滚轮缩放 | G网格 | L标签 | D调试 | R重置 | I详情 | 点击角色

### 游戏模拟器
```bash
cd "d:/projects/AI社区"
# 交互模式
venv/Scripts/python run_simulation.py

# 手动步进模式（执行10步）
venv/Scripts/python run_simulation.py --step 10
```
命令: start | stop | pause | resume | step | status | quit

---

## 更新记录

| 日期 | 内容 |
|------|------|
| 2026-01-23 | 项目初始化，完成后端API基础框架 |
| 2026-01-23 | 完成前端页面开发（首页/帖子/登录/注册/个人中心） |
| 2026-01-24 | 添加文件上传功能，图片存储到本地目录 |
| 2026-01-25 | 完成私聊功能（WebSocket实时消息、会话列表、聊天页面、未读消息Badge） |
| 2026-01-25 | 完成核心引擎开发（时间管理器、事件系统、环境系统） |
| 2026-01-25 | 完成AI角色系统（LLM集成、记忆系统、物品栏、环境感知、Agent） |
| 2026-01-25 | 完成社交功能增强（社交客户端、调度器、事件处理器、AI自动发帖/点赞/评论/私聊） |
| 2026-01-25 | 完成2D可视化系统（Pygame渲染器、相机控制、地点/角色渲染、UI面板） |
| 2026-01-25 | 新增行动日志系统（ActionLog模型、ActionLogger类、可视化日志面板、角色详情面板） |
| 2026-01-31 | 重构模拟整合层：改为基于行动结束触发，支持时间跳跃，AI自主决定睡眠/休息 |
